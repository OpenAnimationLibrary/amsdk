// 

#include "StdAfx.h"
#include "Custom.h"
#include "resource.h"
#include "Matrix34.h"
#include "SDK/HThreadInfo.h"

namespace {
// @formatter:off
float cosTable[1024] = {
    6.12323e-017f, 0.00307096f, 0.00614188f, 0.00921275f, 0.0122835f, 0.0153542f, 0.0184247f, 0.0214951f, 0.0245652f, 0.0276351f, 0.0307048f, 0.0337741f,
    0.0368432f, 0.0399119f, 0.0429802f, 0.0460481f, 0.0491156f, 0.0521826f, 0.0552491f, 0.0583151f, 0.0613806f, 0.0644455f, 0.0675097f, 0.0705734f,
    0.0736363f, 0.0766986f, 0.0797602f, 0.082821f, 0.085881f, 0.0889402f, 0.0919985f, 0.095056f, 0.0981126f, 0.101168f, 0.104223f, 0.107277f,
    0.11033f, 0.113381f, 0.116432f, 0.119481f, 0.12253f, 0.125577f, 0.128623f, 0.131668f, 0.134711f, 0.137754f, 0.140795f, 0.143835f,
    0.146873f, 0.14991f, 0.152945f, 0.155979f, 0.159012f, 0.162043f, 0.165073f, 0.168101f, 0.171127f, 0.174152f, 0.177175f, 0.180197f,
    0.183217f, 0.186235f, 0.189251f, 0.192266f, 0.195279f, 0.198289f, 0.201299f, 0.204306f, 0.207311f, 0.210314f, 0.213315f, 0.216315f,
    0.219312f, 0.222307f, 0.2253f, 0.228291f, 0.23128f, 0.234266f, 0.237251f, 0.240233f, 0.243213f, 0.246191f, 0.249166f, 0.252139f,
    0.255109f, 0.258077f, 0.261043f, 0.264006f, 0.266967f, 0.269925f, 0.272881f, 0.275834f, 0.278785f, 0.281733f, 0.284678f, 0.28762f,
    0.29056f, 0.293497f, 0.296432f, 0.299363f, 0.302292f, 0.305218f, 0.308141f, 0.311061f, 0.313978f, 0.316892f, 0.319803f, 0.322711f,
    0.325617f, 0.328519f, 0.331418f, 0.334313f, 0.337206f, 0.340096f, 0.342982f, 0.345865f, 0.348745f, 0.351621f, 0.354494f, 0.357364f,
    0.360231f, 0.363094f, 0.365954f, 0.36881f, 0.371662f, 0.374512f, 0.377357f, 0.380199f, 0.383038f, 0.385873f, 0.388704f, 0.391532f,
    0.394356f, 0.397176f, 0.399993f, 0.402805f, 0.405614f, 0.408419f, 0.41122f, 0.414018f, 0.416811f, 0.419601f, 0.422386f, 0.425168f,
    0.427945f, 0.430719f, 0.433488f, 0.436254f, 0.439015f, 0.441772f, 0.444525f, 0.447274f, 0.450018f, 0.452759f, 0.455495f, 0.458227f,
    0.460954f, 0.463677f, 0.466396f, 0.46911f, 0.47182f, 0.474525f, 0.477226f, 0.479923f, 0.482615f, 0.485302f, 0.487985f, 0.490663f,
    0.493336f, 0.496005f, 0.49867f, 0.501329f, 0.503984f, 0.506634f, 0.509279f, 0.51192f, 0.514555f, 0.517186f, 0.519812f, 0.522433f,
    0.525049f, 0.52766f, 0.530266f, 0.532868f, 0.535464f, 0.538055f, 0.540641f, 0.543222f, 0.545798f, 0.548368f, 0.550934f, 0.553494f,
    0.556049f, 0.558599f, 0.561143f, 0.563682f, 0.566216f, 0.568745f, 0.571268f, 0.573786f, 0.576298f, 0.578805f, 0.581307f, 0.583803f,
    0.586294f, 0.588779f, 0.591258f, 0.593732f, 0.5962f, 0.598663f, 0.60112f, 0.603571f, 0.606017f, 0.608457f, 0.610891f, 0.613319f,
    0.615742f, 0.618159f, 0.62057f, 0.622975f, 0.625374f, 0.627768f, 0.630155f, 0.632537f, 0.634912f, 0.637282f, 0.639646f, 0.642003f,
    0.644355f, 0.6467f, 0.649039f, 0.651372f, 0.6537f, 0.65602f, 0.658335f, 0.660644f, 0.662946f, 0.665242f, 0.667532f, 0.669815f,
    0.672092f, 0.674363f, 0.676627f, 0.678885f, 0.681137f, 0.683382f, 0.685621f, 0.687853f, 0.690079f, 0.692298f, 0.694511f, 0.696717f,
    0.698917f, 0.70111f, 0.703296f, 0.705476f, 0.707649f, 0.709816f, 0.711976f, 0.714129f, 0.716275f, 0.718415f, 0.720548f, 0.722674f,
    0.724793f, 0.726905f, 0.729011f, 0.731109f, 0.733201f, 0.735286f, 0.737364f, 0.739435f, 0.741499f, 0.743556f, 0.745606f, 0.747649f,
    0.749684f, 0.751713f, 0.753735f, 0.75575f, 0.757757f, 0.759757f, 0.761751f, 0.763737f, 0.765715f, 0.767687f, 0.769651f, 0.771608f,
    0.773558f, 0.775501f, 0.777436f, 0.779364f, 0.781284f, 0.783197f, 0.785103f, 0.787001f, 0.788892f, 0.790776f, 0.792652f, 0.79452f,
    0.796381f, 0.798235f, 0.800081f, 0.801919f, 0.80375f, 0.805574f, 0.807389f, 0.809197f, 0.810998f, 0.812791f, 0.814576f, 0.816353f,
    0.818123f, 0.819885f, 0.82164f, 0.823386f, 0.825125f, 0.826856f, 0.828579f, 0.830295f, 0.832002f, 0.833702f, 0.835394f, 0.837078f,
    0.838754f, 0.840422f, 0.842083f, 0.843735f, 0.845379f, 0.847016f, 0.848644f, 0.850265f, 0.851877f, 0.853481f, 0.855078f, 0.856666f,
    0.858246f, 0.859818f, 0.861382f, 0.862938f, 0.864486f, 0.866025f, 0.867557f, 0.86908f, 0.870595f, 0.872102f, 0.8736f, 0.875091f,
    0.876573f, 0.878047f, 0.879512f, 0.880969f, 0.882418f, 0.883859f, 0.885291f, 0.886715f, 0.888131f, 0.889538f, 0.890937f, 0.892327f,
    0.893709f, 0.895083f, 0.896448f, 0.897805f, 0.899153f, 0.900492f, 0.901824f, 0.903146f, 0.904461f, 0.905766f, 0.907063f, 0.908352f,
    0.909632f, 0.910903f, 0.912166f, 0.91342f, 0.914666f, 0.915903f, 0.917131f, 0.918351f, 0.919562f, 0.920765f, 0.921958f, 0.923143f,
    0.92432f, 0.925487f, 0.926646f, 0.927796f, 0.928937f, 0.93007f, 0.931194f, 0.932309f, 0.933415f, 0.934513f, 0.935601f, 0.936681f,
    0.937752f, 0.938814f, 0.939868f, 0.940912f, 0.941948f, 0.942974f, 0.943992f, 0.945001f, 0.946001f, 0.946992f, 0.947974f, 0.948947f,
    0.949911f, 0.950867f, 0.951813f, 0.95275f, 0.953678f, 0.954598f, 0.955508f, 0.956409f, 0.957302f, 0.958185f, 0.959059f, 0.959924f,
    0.960781f, 0.961628f, 0.962466f, 0.963295f, 0.964114f, 0.964925f, 0.965727f, 0.966519f, 0.967303f, 0.968077f, 0.968842f, 0.969598f,
    0.970345f, 0.971083f, 0.971812f, 0.972531f, 0.973241f, 0.973942f, 0.974634f, 0.975317f, 0.97599f, 0.976655f, 0.97731f, 0.977956f,
    0.978592f, 0.97922f, 0.979838f, 0.980447f, 0.981046f, 0.981637f, 0.982218f, 0.98279f, 0.983353f, 0.983906f, 0.98445f, 0.984985f,
    0.985511f, 0.986027f, 0.986534f, 0.987031f, 0.98752f, 0.987999f, 0.988468f, 0.988929f, 0.98938f, 0.989821f, 0.990254f, 0.990677f,
    0.991091f, 0.991495f, 0.99189f, 0.992276f, 0.992652f, 0.993019f, 0.993376f, 0.993724f, 0.994063f, 0.994393f, 0.994713f, 0.995023f,
    0.995325f, 0.995617f, 0.995899f, 0.996172f, 0.996436f, 0.99669f, 0.996935f, 0.997171f, 0.997397f, 0.997614f, 0.997821f, 0.998019f,
    0.998208f, 0.998387f, 0.998556f, 0.998717f, 0.998867f, 0.999009f, 0.999141f, 0.999263f, 0.999376f, 0.99948f, 0.999574f, 0.999659f,
    0.999735f, 0.999801f, 0.999857f, 0.999905f, 0.999942f, 0.999971f, 0.999989f, 0.999999f, 0.999999f, 0.999989f, 0.999971f, 0.999942f,
    0.999905f, 0.999857f, 0.999801f, 0.999735f, 0.999659f, 0.999574f, 0.99948f, 0.999376f, 0.999263f, 0.999141f, 0.999009f, 0.998867f,
    0.998717f, 0.998556f, 0.998387f, 0.998208f, 0.998019f, 0.997821f, 0.997614f, 0.997397f, 0.997171f, 0.996935f, 0.99669f, 0.996436f,
    0.996172f, 0.995899f, 0.995617f, 0.995325f, 0.995023f, 0.994713f, 0.994393f, 0.994063f, 0.993724f, 0.993376f, 0.993019f, 0.992652f,
    0.992276f, 0.99189f, 0.991495f, 0.991091f, 0.990677f, 0.990254f, 0.989821f, 0.98938f, 0.988929f, 0.988468f, 0.987999f, 0.98752f,
    0.987031f, 0.986534f, 0.986027f, 0.985511f, 0.984985f, 0.98445f, 0.983906f, 0.983353f, 0.98279f, 0.982218f, 0.981637f, 0.981046f,
    0.980447f, 0.979838f, 0.97922f, 0.978592f, 0.977956f, 0.97731f, 0.976655f, 0.97599f, 0.975317f, 0.974634f, 0.973942f, 0.973241f,
    0.972531f, 0.971812f, 0.971083f, 0.970345f, 0.969598f, 0.968842f, 0.968077f, 0.967303f, 0.966519f, 0.965727f, 0.964925f, 0.964114f,
    0.963295f, 0.962466f, 0.961628f, 0.960781f, 0.959924f, 0.959059f, 0.958185f, 0.957302f, 0.956409f, 0.955508f, 0.954598f, 0.953678f,
    0.95275f, 0.951813f, 0.950867f, 0.949911f, 0.948947f, 0.947974f, 0.946992f, 0.946001f, 0.945001f, 0.943992f, 0.942974f, 0.941948f,
    0.940912f, 0.939868f, 0.938814f, 0.937752f, 0.936681f, 0.935601f, 0.934513f, 0.933415f, 0.932309f, 0.931194f, 0.93007f, 0.928937f,
    0.927796f, 0.926646f, 0.925487f, 0.92432f, 0.923143f, 0.921958f, 0.920765f, 0.919562f, 0.918351f, 0.917131f, 0.915903f, 0.914666f,
    0.91342f, 0.912166f, 0.910903f, 0.909632f, 0.908352f, 0.907063f, 0.905766f, 0.904461f, 0.903146f, 0.901824f, 0.900492f, 0.899153f,
    0.897805f, 0.896448f, 0.895083f, 0.893709f, 0.892327f, 0.890937f, 0.889538f, 0.888131f, 0.886715f, 0.885291f, 0.883859f, 0.882418f,
    0.880969f, 0.879512f, 0.878047f, 0.876573f, 0.875091f, 0.8736f, 0.872102f, 0.870595f, 0.86908f, 0.867557f, 0.866025f, 0.864486f,
    0.862938f, 0.861382f, 0.859818f, 0.858246f, 0.856666f, 0.855078f, 0.853481f, 0.851877f, 0.850265f, 0.848644f, 0.847016f, 0.845379f,
    0.843735f, 0.842083f, 0.840422f, 0.838754f, 0.837078f, 0.835394f, 0.833702f, 0.832002f, 0.830295f, 0.828579f, 0.826856f, 0.825125f,
    0.823386f, 0.82164f, 0.819885f, 0.818123f, 0.816353f, 0.814576f, 0.812791f, 0.810998f, 0.809197f, 0.807389f, 0.805574f, 0.80375f,
    0.801919f, 0.800081f, 0.798235f, 0.796381f, 0.79452f, 0.792652f, 0.790776f, 0.788892f, 0.787001f, 0.785103f, 0.783197f, 0.781284f,
    0.779364f, 0.777436f, 0.775501f, 0.773558f, 0.771608f, 0.769651f, 0.767687f, 0.765715f, 0.763737f, 0.761751f, 0.759757f, 0.757757f,
    0.75575f, 0.753735f, 0.751713f, 0.749684f, 0.747649f, 0.745606f, 0.743556f, 0.741499f, 0.739435f, 0.737364f, 0.735286f, 0.733201f,
    0.731109f, 0.729011f, 0.726905f, 0.724793f, 0.722674f, 0.720548f, 0.718415f, 0.716275f, 0.714129f, 0.711976f, 0.709816f, 0.707649f,
    0.705476f, 0.703296f, 0.70111f, 0.698917f, 0.696717f, 0.694511f, 0.692298f, 0.690079f, 0.687853f, 0.685621f, 0.683382f, 0.681137f,
    0.678885f, 0.676627f, 0.674363f, 0.672092f, 0.669815f, 0.667532f, 0.665242f, 0.662946f, 0.660644f, 0.658335f, 0.65602f, 0.6537f,
    0.651372f, 0.649039f, 0.6467f, 0.644355f, 0.642003f, 0.639646f, 0.637282f, 0.634912f, 0.632537f, 0.630155f, 0.627768f, 0.625374f,
    0.622975f, 0.62057f, 0.618159f, 0.615742f, 0.613319f, 0.610891f, 0.608457f, 0.606017f, 0.603571f, 0.60112f, 0.598663f, 0.5962f,
    0.593732f, 0.591258f, 0.588779f, 0.586294f, 0.583803f, 0.581307f, 0.578805f, 0.576298f, 0.573786f, 0.571268f, 0.568745f, 0.566216f,
    0.563682f, 0.561143f, 0.558599f, 0.556049f, 0.553494f, 0.550934f, 0.548368f, 0.545798f, 0.543222f, 0.540641f, 0.538055f, 0.535464f,
    0.532868f, 0.530266f, 0.52766f, 0.525049f, 0.522433f, 0.519812f, 0.517186f, 0.514555f, 0.51192f, 0.509279f, 0.506634f, 0.503984f,
    0.501329f, 0.49867f, 0.496005f, 0.493336f, 0.490663f, 0.487985f, 0.485302f, 0.482615f, 0.479923f, 0.477226f, 0.474525f, 0.47182f,
    0.46911f, 0.466396f, 0.463677f, 0.460954f, 0.458227f, 0.455495f, 0.452759f, 0.450018f, 0.447274f, 0.444525f, 0.441772f, 0.439015f,
    0.436254f, 0.433488f, 0.430719f, 0.427945f, 0.425168f, 0.422386f, 0.419601f, 0.416811f, 0.414018f, 0.41122f, 0.408419f, 0.405614f,
    0.402805f, 0.399993f, 0.397176f, 0.394356f, 0.391532f, 0.388704f, 0.385873f, 0.383038f, 0.380199f, 0.377357f, 0.374512f, 0.371662f,
    0.36881f, 0.365954f, 0.363094f, 0.360231f, 0.357364f, 0.354494f, 0.351621f, 0.348745f, 0.345865f, 0.342982f, 0.340096f, 0.337206f,
    0.334313f, 0.331418f, 0.328519f, 0.325617f, 0.322711f, 0.319803f, 0.316892f, 0.313978f, 0.311061f, 0.308141f, 0.305218f, 0.302292f,
    0.299363f, 0.296432f, 0.293497f, 0.29056f, 0.28762f, 0.284678f, 0.281733f, 0.278785f, 0.275834f, 0.272881f, 0.269925f, 0.266967f,
    0.264006f, 0.261043f, 0.258077f, 0.255109f, 0.252139f, 0.249166f, 0.246191f, 0.243213f, 0.240233f, 0.237251f, 0.234266f, 0.23128f,
    0.228291f, 0.2253f, 0.222307f, 0.219312f, 0.216315f, 0.213315f, 0.210314f, 0.207311f, 0.204306f, 0.201299f, 0.198289f, 0.195279f,
    0.192266f, 0.189251f, 0.186235f, 0.183217f, 0.180197f, 0.177175f, 0.174152f, 0.171127f, 0.168101f, 0.165073f, 0.162043f, 0.159012f,
    0.155979f, 0.152945f, 0.14991f, 0.146873f, 0.143835f, 0.140795f, 0.137754f, 0.134711f, 0.131668f, 0.128623f, 0.125577f, 0.12253f,
    0.119481f, 0.116432f, 0.113381f, 0.11033f, 0.107277f, 0.104223f, 0.101168f, 0.0981126f, 0.095056f, 0.0919985f, 0.0889402f, 0.085881f,
    0.082821f, 0.0797602f, 0.0766986f, 0.0736363f, 0.0705734f, 0.0675097f, 0.0644455f, 0.0613806f, 0.0583151f, 0.0552491f, 0.0521826f, 0.0491156f,
    0.0460481f, 0.0429802f, 0.0399119f, 0.0368432f, 0.0337741f, 0.0307048f, 0.0276351f, 0.0245652f, 0.0214951f, 0.0184247f, 0.0153542f, 0.0122835f,
    0.00921275f, 0.00614188f, 0.00307096f
};

float acosTable[1024] = {
    1.5708f, 1.56982f, 1.56884f, 1.56786f, 1.56689f, 1.56591f, 1.56493f, 1.56395f, 1.56298f, 1.562f, 1.56102f, 1.56004f,
    1.55907f, 1.55809f, 1.55711f, 1.55613f, 1.55516f, 1.55418f, 1.5532f, 1.55222f, 1.55124f, 1.55027f, 1.54929f, 1.54831f,
    1.54733f, 1.54636f, 1.54538f, 1.5444f, 1.54342f, 1.54244f, 1.54147f, 1.54049f, 1.53951f, 1.53853f, 1.53755f, 1.53658f,
    1.5356f, 1.53462f, 1.53364f, 1.53266f, 1.53169f, 1.53071f, 1.52973f, 1.52875f, 1.52777f, 1.52679f, 1.52582f, 1.52484f,
    1.52386f, 1.52288f, 1.5219f, 1.52092f, 1.51994f, 1.51896f, 1.51799f, 1.51701f, 1.51603f, 1.51505f, 1.51407f, 1.51309f,
    1.51211f, 1.51113f, 1.51015f, 1.50917f, 1.50819f, 1.50721f, 1.50624f, 1.50526f, 1.50428f, 1.5033f, 1.50232f, 1.50134f,
    1.50036f, 1.49938f, 1.4984f, 1.49742f, 1.49644f, 1.49546f, 1.49448f, 1.4935f, 1.49252f, 1.49153f, 1.49055f, 1.48957f,
    1.48859f, 1.48761f, 1.48663f, 1.48565f, 1.48467f, 1.48369f, 1.48271f, 1.48172f, 1.48074f, 1.47976f, 1.47878f, 1.4778f,
    1.47682f, 1.47583f, 1.47485f, 1.47387f, 1.47289f, 1.47191f, 1.47092f, 1.46994f, 1.46896f, 1.46798f, 1.46699f, 1.46601f,
    1.46503f, 1.46404f, 1.46306f, 1.46208f, 1.46109f, 1.46011f, 1.45913f, 1.45814f, 1.45716f, 1.45618f, 1.45519f, 1.45421f,
    1.45322f, 1.45224f, 1.45125f, 1.45027f, 1.44929f, 1.4483f, 1.44732f, 1.44633f, 1.44535f, 1.44436f, 1.44337f, 1.44239f,
    1.4414f, 1.44042f, 1.43943f, 1.43845f, 1.43746f, 1.43647f, 1.43549f, 1.4345f, 1.43351f, 1.43253f, 1.43154f, 1.43055f,
    1.42956f, 1.42858f, 1.42759f, 1.4266f, 1.42561f, 1.42463f, 1.42364f, 1.42265f, 1.42166f, 1.42067f, 1.41968f, 1.4187f,
    1.41771f, 1.41672f, 1.41573f, 1.41474f, 1.41375f, 1.41276f, 1.41177f, 1.41078f, 1.40979f, 1.4088f, 1.40781f, 1.40682f,
    1.40583f, 1.40484f, 1.40384f, 1.40285f, 1.40186f, 1.40087f, 1.39988f, 1.39889f, 1.39789f, 1.3969f, 1.39591f, 1.39492f,
    1.39392f, 1.39293f, 1.39194f, 1.39094f, 1.38995f, 1.38896f, 1.38796f, 1.38697f, 1.38597f, 1.38498f, 1.38398f, 1.38299f,
    1.38199f, 1.381f, 1.38f, 1.37901f, 1.37801f, 1.37701f, 1.37602f, 1.37502f, 1.37403f, 1.37303f, 1.37203f, 1.37103f,
    1.37004f, 1.36904f, 1.36804f, 1.36704f, 1.36605f, 1.36505f, 1.36405f, 1.36305f, 1.36205f, 1.36105f, 1.36005f, 1.35905f,
    1.35805f, 1.35705f, 1.35605f, 1.35505f, 1.35405f, 1.35305f, 1.35205f, 1.35105f, 1.35004f, 1.34904f, 1.34804f, 1.34704f,
    1.34603f, 1.34503f, 1.34403f, 1.34303f, 1.34202f, 1.34102f, 1.34001f, 1.33901f, 1.33801f, 1.337f, 1.336f, 1.33499f,
    1.33399f, 1.33298f, 1.33197f, 1.33097f, 1.32996f, 1.32895f, 1.32795f, 1.32694f, 1.32593f, 1.32492f, 1.32392f, 1.32291f,
    1.3219f, 1.32089f, 1.31988f, 1.31887f, 1.31786f, 1.31685f, 1.31584f, 1.31483f, 1.31382f, 1.31281f, 1.3118f, 1.31079f,
    1.30978f, 1.30877f, 1.30775f, 1.30674f, 1.30573f, 1.30472f, 1.3037f, 1.30269f, 1.30167f, 1.30066f, 1.29965f, 1.29863f,
    1.29762f, 1.2966f, 1.29559f, 1.29457f, 1.29355f, 1.29254f, 1.29152f, 1.2905f, 1.28949f, 1.28847f, 1.28745f, 1.28643f,
    1.28541f, 1.28439f, 1.28338f, 1.28236f, 1.28134f, 1.28032f, 1.2793f, 1.27827f, 1.27725f, 1.27623f, 1.27521f, 1.27419f,
    1.27317f, 1.27214f, 1.27112f, 1.2701f, 1.26907f, 1.26805f, 1.26703f, 1.266f, 1.26498f, 1.26395f, 1.26293f, 1.2619f,
    1.26087f, 1.25985f, 1.25882f, 1.25779f, 1.25676f, 1.25574f, 1.25471f, 1.25368f, 1.25265f, 1.25162f, 1.25059f, 1.24956f,
    1.24853f, 1.2475f, 1.24647f, 1.24544f, 1.24441f, 1.24337f, 1.24234f, 1.24131f, 1.24028f, 1.23924f, 1.23821f, 1.23717f,
    1.23614f, 1.2351f, 1.23407f, 1.23303f, 1.232f, 1.23096f, 1.22992f, 1.22889f, 1.22785f, 1.22681f, 1.22577f, 1.22473f,
    1.22369f, 1.22265f, 1.22161f, 1.22057f, 1.21953f, 1.21849f, 1.21745f, 1.21641f, 1.21536f, 1.21432f, 1.21328f, 1.21223f,
    1.21119f, 1.21015f, 1.2091f, 1.20805f, 1.20701f, 1.20596f, 1.20492f, 1.20387f, 1.20282f, 1.20177f, 1.20073f, 1.19968f,
    1.19863f, 1.19758f, 1.19653f, 1.19548f, 1.19443f, 1.19338f, 1.19232f, 1.19127f, 1.19022f, 1.18917f, 1.18811f, 1.18706f,
    1.186f, 1.18495f, 1.18389f, 1.18284f, 1.18178f, 1.18073f, 1.17967f, 1.17861f, 1.17755f, 1.17649f, 1.17543f, 1.17438f,
    1.17332f, 1.17226f, 1.17119f, 1.17013f, 1.16907f, 1.16801f, 1.16695f, 1.16588f, 1.16482f, 1.16375f, 1.16269f, 1.16162f,
    1.16056f, 1.15949f, 1.15843f, 1.15736f, 1.15629f, 1.15522f, 1.15415f, 1.15308f, 1.15202f, 1.15095f, 1.14987f, 1.1488f,
    1.14773f, 1.14666f, 1.14559f, 1.14451f, 1.14344f, 1.14236f, 1.14129f, 1.14021f, 1.13914f, 1.13806f, 1.13698f, 1.13591f,
    1.13483f, 1.13375f, 1.13267f, 1.13159f, 1.13051f, 1.12943f, 1.12835f, 1.12727f, 1.12618f, 1.1251f, 1.12402f, 1.12293f,
    1.12185f, 1.12076f, 1.11968f, 1.11859f, 1.1175f, 1.11642f, 1.11533f, 1.11424f, 1.11315f, 1.11206f, 1.11097f, 1.10988f,
    1.10879f, 1.10769f, 1.1066f, 1.10551f, 1.10441f, 1.10332f, 1.10222f, 1.10113f, 1.10003f, 1.09893f, 1.09784f, 1.09674f,
    1.09564f, 1.09454f, 1.09344f, 1.09234f, 1.09124f, 1.09014f, 1.08903f, 1.08793f, 1.08682f, 1.08572f, 1.08461f, 1.08351f,
    1.0824f, 1.0813f, 1.08019f, 1.07908f, 1.07797f, 1.07686f, 1.07575f, 1.07464f, 1.07353f, 1.07241f, 1.0713f, 1.07019f,
    1.06907f, 1.06796f, 1.06684f, 1.06572f, 1.06461f, 1.06349f, 1.06237f, 1.06125f, 1.06013f, 1.05901f, 1.05789f, 1.05677f,
    1.05564f, 1.05452f, 1.05339f, 1.05227f, 1.05114f, 1.05002f, 1.04889f, 1.04776f, 1.04663f, 1.0455f, 1.04437f, 1.04324f,
    1.04211f, 1.04098f, 1.03985f, 1.03871f, 1.03758f, 1.03644f, 1.0353f, 1.03417f, 1.03303f, 1.03189f, 1.03075f, 1.02961f,
    1.02847f, 1.02733f, 1.02619f, 1.02504f, 1.0239f, 1.02275f, 1.02161f, 1.02046f, 1.01932f, 1.01817f, 1.01702f, 1.01587f,
    1.01472f, 1.01357f, 1.01241f, 1.01126f, 1.01011f, 1.00895f, 1.0078f, 1.00664f, 1.00548f, 1.00433f, 1.00317f, 1.00201f,
    1.00085f, 0.999685f, 0.998523f, 0.99736f, 0.996196f, 0.995031f, 0.993865f, 0.992698f, 0.991531f, 0.990362f, 0.989193f, 0.988022f,
    0.986851f, 0.985679f, 0.984506f, 0.983332f, 0.982157f, 0.980981f, 0.979805f, 0.978627f, 0.977448f, 0.976269f, 0.975088f, 0.973907f,
    0.972725f, 0.971541f, 0.970357f, 0.969172f, 0.967986f, 0.966799f, 0.96561f, 0.964421f, 0.963231f, 0.96204f, 0.960848f, 0.959655f,
    0.958461f, 0.957266f, 0.95607f, 0.954873f, 0.953675f, 0.952476f, 0.951275f, 0.950074f, 0.948872f, 0.947669f, 0.946465f, 0.945259f,
    0.944053f, 0.942845f, 0.941637f, 0.940427f, 0.939217f, 0.938005f, 0.936792f, 0.935578f, 0.934364f, 0.933147f, 0.93193f, 0.930712f,
    0.929493f, 0.928272f, 0.927051f, 0.925828f, 0.924604f, 0.923379f, 0.922153f, 0.920926f, 0.919698f, 0.918468f, 0.917238f, 0.916006f,
    0.914773f, 0.913539f, 0.912303f, 0.911067f, 0.909829f, 0.90859f, 0.90735f, 0.906109f, 0.904866f, 0.903622f, 0.902377f, 0.901131f,
    0.899884f, 0.898635f, 0.897385f, 0.896134f, 0.894882f, 0.893628f, 0.892373f, 0.891117f, 0.88986f, 0.888601f, 0.887341f, 0.88608f,
    0.884817f, 0.883553f, 0.882288f, 0.881021f, 0.879753f, 0.878484f, 0.877214f, 0.875942f, 0.874669f, 0.873394f, 0.872118f, 0.870841f,
    0.869562f, 0.868282f, 0.867f, 0.865718f, 0.864433f, 0.863148f, 0.86186f, 0.860572f, 0.859282f, 0.857991f, 0.856698f, 0.855403f,
    0.854108f, 0.852811f, 0.851512f, 0.850212f, 0.84891f, 0.847607f, 0.846302f, 0.844996f, 0.843689f, 0.842379f, 0.841069f, 0.839756f,
    0.838443f, 0.837127f, 0.83581f, 0.834492f, 0.833172f, 0.83185f, 0.830527f, 0.829202f, 0.827876f, 0.826548f, 0.825218f, 0.823887f,
    0.822554f, 0.821219f, 0.819883f, 0.818545f, 0.817205f, 0.815864f, 0.814521f, 0.813176f, 0.81183f, 0.810482f, 0.809132f, 0.80778f,
    0.806427f, 0.805072f, 0.803715f, 0.802356f, 0.800996f, 0.799633f, 0.798269f, 0.796903f, 0.795536f, 0.794166f, 0.792795f, 0.791422f,
    0.790046f, 0.788669f, 0.787291f, 0.78591f, 0.784527f, 0.783143f, 0.781756f, 0.780368f, 0.778977f, 0.777585f, 0.776191f, 0.774794f,
    0.773396f, 0.771996f, 0.770593f, 0.769189f, 0.767783f, 0.766374f, 0.764964f, 0.763551f, 0.762136f, 0.760719f, 0.759301f, 0.75788f,
    0.756456f, 0.755031f, 0.753604f, 0.752174f, 0.750742f, 0.749308f, 0.747872f, 0.746433f, 0.744993f, 0.74355f, 0.742104f, 0.740657f,
    0.739207f, 0.737755f, 0.736301f, 0.734844f, 0.733385f, 0.731923f, 0.730459f, 0.728993f, 0.727524f, 0.726053f, 0.72458f, 0.723104f,
    0.721625f, 0.720144f, 0.718661f, 0.717175f, 0.715686f, 0.714195f, 0.712701f, 0.711205f, 0.709706f, 0.708205f, 0.706701f, 0.705194f,
    0.703685f, 0.702172f, 0.700658f, 0.69914f, 0.69762f, 0.696097f, 0.694571f, 0.693042f, 0.691511f, 0.689976f, 0.688439f, 0.686899f,
    0.685356f, 0.68381f, 0.682262f, 0.68071f, 0.679155f, 0.677598f, 0.676037f, 0.674473f, 0.672906f, 0.671336f, 0.669763f, 0.668187f,
    0.666608f, 0.665025f, 0.663439f, 0.661851f, 0.660258f, 0.658663f, 0.657064f, 0.655462f, 0.653857f, 0.652248f, 0.650636f, 0.64902f,
    0.647401f, 0.645779f, 0.644153f, 0.642523f, 0.64089f, 0.639253f, 0.637613f, 0.635969f, 0.634321f, 0.63267f, 0.631015f, 0.629356f,
    0.627694f, 0.626027f, 0.624357f, 0.622683f, 0.621005f, 0.619323f, 0.617637f, 0.615947f, 0.614253f, 0.612555f, 0.610853f, 0.609146f,
    0.607436f, 0.605721f, 0.604002f, 0.602279f, 0.600551f, 0.598819f, 0.597082f, 0.595342f, 0.593596f, 0.591846f, 0.590092f, 0.588333f,
    0.586569f, 0.584801f, 0.583028f, 0.58125f, 0.579467f, 0.577679f, 0.575887f, 0.574089f, 0.572287f, 0.570479f, 0.568667f, 0.566849f,
    0.565026f, 0.563198f, 0.561364f, 0.559525f, 0.557681f, 0.555831f, 0.553975f, 0.552114f, 0.550248f, 0.548376f, 0.546498f, 0.544614f,
    0.542724f, 0.540828f, 0.538927f, 0.537019f, 0.535105f, 0.533185f, 0.531259f, 0.529326f, 0.527387f, 0.525441f, 0.523489f, 0.521531f,
    0.519565f, 0.517593f, 0.515614f, 0.513628f, 0.511635f, 0.509635f, 0.507627f, 0.505613f, 0.503591f, 0.501562f, 0.499525f, 0.49748f,
    0.495428f, 0.493368f, 0.4913f, 0.489224f, 0.48714f, 0.485047f, 0.482946f, 0.480837f, 0.478719f, 0.476593f, 0.474458f, 0.472314f,
    0.47016f, 0.467998f, 0.465827f, 0.463645f, 0.461455f, 0.459255f, 0.457044f, 0.454824f, 0.452594f, 0.450354f, 0.448103f, 0.445841f,
    0.443569f, 0.441286f, 0.438991f, 0.436686f, 0.434369f, 0.43204f, 0.4297f, 0.427347f, 0.424983f, 0.422605f, 0.420216f, 0.417813f,
    0.415397f, 0.412968f, 0.410526f, 0.40807f, 0.405599f, 0.403115f, 0.400616f, 0.398102f, 0.395572f, 0.393028f, 0.390468f, 0.387891f,
    0.385299f, 0.382689f, 0.380063f, 0.377419f, 0.374758f, 0.372078f, 0.36938f, 0.366663f, 0.363927f, 0.36117f, 0.358394f, 0.355597f,
    0.352778f, 0.349938f, 0.347076f, 0.34419f, 0.341282f, 0.338349f, 0.335391f, 0.332409f, 0.3294f, 0.326365f, 0.323302f, 0.320211f,
    0.317091f, 0.31394f, 0.310759f, 0.307546f, 0.304301f, 0.301021f, 0.297707f, 0.294356f, 0.290968f, 0.28754f, 0.284073f, 0.280564f,
    0.277012f, 0.273415f, 0.269771f, 0.266079f, 0.262336f, 0.258539f, 0.254688f, 0.250779f, 0.246809f, 0.242776f, 0.238675f, 0.234505f,
    0.23026f, 0.225937f, 0.221532f, 0.217038f, 0.212451f, 0.207764f, 0.20297f, 0.198063f, 0.193032f, 0.187868f, 0.18256f, 0.177094f,
    0.171457f, 0.16563f, 0.159592f, 0.153318f, 0.146779f, 0.139937f, 0.132745f, 0.125143f, 0.117051f, 0.108359f, 0.0989098f, 0.0884604f,
    0.0766027f, 0.0625407f, 0.0442194f
};
    // @formatter:on
}

HProperty *CustomShader::GetPropertyAt(const int i) {
    switch (i) {
        case 0:
            return m_primWidth;
        case 1:
            return m_scndryWidth;
        case 2:
            return m_transWidth;
        case 3:
            return m_primDev;
        case 4:
            return m_scndryDev;
        case 5:
            return m_transDev;
        case 6:
            return m_primStrength;
        case 7:
            return m_scndryStrength;
        case 8:
            return m_transStrength;
        case 9:
            return m_ior;
        case 10:
            return m_fresnelAmt;
        case 11:
            return m_directionAtten;
        case 12:
            return m_specBlend;
        default:
            return nullptr;
    }
}

const char *CustomShader::GetShaderDiffuseFilters() {
    return nullptr;
}

const char *CustomShader::GetShaderSpecularFilters() {
    AFX_MANAGE_STATE(AfxGetStaticModuleState())
    static CString filter;
    filter.LoadString(IDS_MENUFILTER);
    return filter;
}

void CustomShader::GetDiffuse(HShading *shading) {}

inline float normalDist(const float stddev, const float x) {
    const float invstddev = hash_math::rcp(stddev);
    const float value = 2.5066283f * invstddev * hash_math::exp(-(hash_math::sqr(x) / (2.F * hash_math::sqr(stddev))));
    return value / (2.5066283f * invstddev);
}

inline float fresnel(const float ior1, const float ior2, const float costheta) {
    const float n = ior1 / ior2;
    const float c = costheta * n;
    const float g = hash_math::sqrt(1.F + hash_math::sqr(c) - hash_math::sqr(n));
    return 0.5f * (hash_math::sqr((g - c) / (g + c)) * (1.F + hash_math::sqr((c * (g + c) - n * n) / (c * (g - c) + n * n))));
}

/**
* Calculates the smoothstep transition between a and b using hermite interpolation
**/
float smoothstep(const float a, const float b, const float x) {
    if (x < a)
        return 0.F;
    if (x >= b)
        return 1.F;
    const float x1 = (x - a) / (b - a);
    return 1.F - hash_math::sqr(x1) * (3.F - 2.F * x1);
}

bool CustomShader::GetSpecular(HShading *shading, const RGBFloat &lightcolor) {
    HTexInfo *htexinfo = shading->GetTexInfo();
    HAttrProperty *hattr = htexinfo->GetAttr();
    const float intensity = shading->GetIntensity();
    const RGBFloat dcol = hattr->GetDiffuseColor()->GetNormalizedRGBFloat();
    const RGBFloat scol = hattr->GetSpecularColor()->GetNormalizedRGBFloat();

    // Get Specular Highlight Properties
    const float pW = m_primWidth->GetValue();
    const float sW = m_scndryWidth->GetValue();
    const float tW = m_transWidth->GetValue();

    const float ior = m_ior->GetValue();
    const float fresnel_amt = m_fresnelAmt->GetValue();

    const float prim_deviation = m_primDev->GetValue();
    const float prim_shininess = 8.25f - 8.25f * pW + 0.01f;
    const float sec_deviation = m_scndryDev->GetValue();
    const float sec_shininess = 8.25f - 8.25f * sW + 0.01f;
    const float tran_deviation = m_transDev->GetValue();
    const float tran_shininess = 8.25f - 8.25f * tW + 0.01f;
    const float prim_strenth = m_primStrength->GetValue();
    const float sec_strenth = m_scndryStrength->GetValue();
    const float trans_strenth = m_transStrength->GetValue();

    const float directionality = m_directionAtten->GetValue();
    const float spec_blend = m_specBlend->GetValue();

    // Calculate the real normal
    //float value = 2.F * shading->GetHit()->GetU() - 1.F;
    //float cosTheta = value;

    const float crossloc = hash_math::fmod(shading->GetHit()->GetU(), 1.0f);
    const float costheta = cosTable[(int)(crossloc * TABLE_SIZE)];

    float fresnelValue = fresnel(1.F, ior, costheta);

    if (fresnelValue < 0.F)
        fresnelValue = 0.F;
    else if (fresnelValue > 1.F)
        fresnelValue = 1.F;

    fresnelValue = 1.F - fresnel_amt + fresnelValue * fresnel_amt;
    const float dim_fresnel = 1.F - fresnel_amt + (1.F - fresnelValue) * fresnel_amt;

    Vector T = shading->GetHairTangent();
    T.Normalize();

    Vector V = shading->GetHairCenter().Normalized();
    V.Negate();

    Vector L = *shading->GetL();
    L.Negate();
    L.Normalize();

    const Vector N = *htexinfo->GetN();

    // Calculate the Primary Highlight 
    V = htexinfo->GetD();
    V.Negate();
    V.Normalize();

    // and bend it for our normal blending purposes
    Vector tang = T * (1.F - spec_blend) - N * spec_blend;
    tang.Normalize();

    float view_dot = V.Dot(L) / 2.F + 0.5f;
    float back_dot = 1.F - view_dot;

    view_dot = view_dot * directionality + (1.F - directionality);
    back_dot = back_dot * directionality + (1.F - directionality);

    // Calculate the halfway vector
    Vector H = V + L;
    H.Normalize();

    Vector norm = H + T * prim_deviation;
    norm.Normalize();

    float light_dot = T.Dot(norm);
    light_dot = 1.F - light_dot * light_dot;

    // compute PRIMARY specular highlight, with fresnel falloff
    light_dot = normalDist(hash_math::rcp(prim_shininess), acosTable[(int)(light_dot * TABLE_SIZE)]) * fresnelValue;

    RGBFloat speccolor = lightcolor * light_dot * scol * view_dot * intensity * prim_strenth;

    // compute SECONDARY specular highlight

    // apply deviation
    norm = H + T * sec_deviation;
    norm.Normalize();

    light_dot = tang.Dot(norm);
    light_dot = 1.F - light_dot * light_dot;

    light_dot = normalDist(hash_math::rcp(sec_shininess), acosTable[(int)(light_dot * TABLE_SIZE)]);

    speccolor += lightcolor * light_dot * dcol * view_dot * intensity * sec_strenth;

    // compute TRANSLUCENT specular highlight

    // recompute halfway vector, since we now base it on the
    // inverted view direction

    V.Negate();
    H = V + L;
    H.Normalize();

    norm = H + T * tran_deviation;
    norm.Normalize();

    light_dot = tang.Dot(norm);
    light_dot = 1.F - light_dot * light_dot;

    light_dot = normalDist(hash_math::rcp(tran_shininess), acosTable[(int)(light_dot * TABLE_SIZE)]) * dim_fresnel;

    // specular
    speccolor += lightcolor * light_dot * dcol * back_dot * intensity * trans_strenth;

    shading->SetSCol(speccolor);

    return true;
}
